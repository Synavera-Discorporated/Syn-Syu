#!/usr/bin/env bash
#============================================================
# Synavera Project: Syn-Syu
# Module: synsyu/syn-syu
# Etiquette: Synavera Script Etiquette â€” Bash Profile v1.1.1
#------------------------------------------------------------
# Purpose:
#   Syn-Syu orchestrates conscious package updates across
#   pacman repositories and the Arch User Repository by
#   delegating manifest construction to synsyu_core and
#   executing selective upgrade strategies.
#
# Security / Safety Notes:
#   - Operates with user privileges; uses sudo only for
#     pacman helper invocations when required.
#   - Writes logs under user-owned directories.
#   - Requires explicit flags before touching AUR or repo state.
#
# Dependencies:
#   jq, python3 (tomllib), sha256sum, synsyu_core, pacman,
#   available AUR helpers (paru, yay, etc.).
#
# Operational Scope:
#   Provides subcommands such as sync, core, update, group,
#   aur, repo, inspect, check, clean, log, and help.
#
# Revision History:
#   2025-10-28 COD  Authored Syn-Syu orchestrator (v0.13).
#   2025-11-11 COD  Refactored into modular structure (hybrid).
#------------------------------------------------------------
# SSE Principles Observed:
#   - set -euo pipefail for predictable exits
#   - Explicit logging of all significant actions
#   - Structured modules for helpers, logging, and manifest IO
#============================================================

set -euo pipefail
IFS=$'\n\t'

SESSION_STAMP="$(date -u +"%Y-%m-%d_%H-%M-%S")"
readonly SESSION_STAMP

SCRIPT_PATH="$(realpath "$0")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
readonly SCRIPT_DIR

LIB_DIR=""
LIB_SEARCH_PATHS=("$SCRIPT_DIR/lib")
if [ -n "${SYNSYU_LIBDIR:-}" ]; then
  LIB_SEARCH_PATHS+=("$SYNSYU_LIBDIR")
fi
if [ -n "${SYN_SYU_LIBDIR:-}" ]; then
  LIB_SEARCH_PATHS+=("$SYN_SYU_LIBDIR")
fi
LIB_SEARCH_PATHS+=(
  "/usr/local/share/syn-syu"
  "/usr/lib/syn-syu"
  "$HOME/.local/share/syn-syu/lib"
  "/usr/local/share/synsyu"
  "/usr/lib/synsyu"
  "$HOME/.local/share/synsyu/lib"
)
for candidate in "${LIB_SEARCH_PATHS[@]}"; do
  if [ -f "$candidate/logging.sh" ]; then
    LIB_DIR="$candidate"
    break
  fi
done

if [ -z "$LIB_DIR" ]; then
  printf 'Syn-Syu cannot locate its library modules. Set SYN_SYU_LIBDIR (or legacy SYNSYU_LIBDIR) to the directory containing logging.sh.\n' >&2
  exit 120
fi

# shellcheck source=/dev/null
. "$LIB_DIR/logging.sh"
# shellcheck source=/dev/null
. "$LIB_DIR/helpers.sh"
# shellcheck source=/dev/null
. "$LIB_DIR/manifest.sh"
# shellcheck source=/dev/null
. "$LIB_DIR/common.sh"
# shellcheck source=/dev/null
. "$LIB_DIR/config.sh"
# shellcheck source=/dev/null
. "$LIB_DIR/common.sh"
# shellcheck source=/dev/null
. "$LIB_DIR/cli.sh"
# shellcheck source=/dev/null
. "$LIB_DIR/disk.sh"
# shellcheck source=/dev/null
. "$LIB_DIR/apps.sh"
# shellcheck source=/dev/null
. "$LIB_DIR/plan.sh"
# shellcheck source=/dev/null
. "$LIB_DIR/commands.sh"

REQUIRED_MODULES=("logging.sh" "helpers.sh" "manifest.sh" "common.sh" "config.sh" "cli.sh" "disk.sh" "apps.sh" "plan.sh" "commands.sh")
for _mod in "${REQUIRED_MODULES[@]}"; do
  if [ ! -f "$LIB_DIR/$_mod" ]; then
    printf 'Syn-Syu missing module %s in %s. Please reinstall syn-syu to restore required libraries.\n' "$_mod" "$LIB_DIR" >&2
    exit 121
  fi
done

# Prefer env override > PATH discovery > distro path
readonly SYN_CORE_BIN="${SYN_CORE_BIN:-$(command -v synsyu_core 2>/dev/null || echo /usr/bin/synsyu_core)}"
readonly DEFAULT_CONFIG_PATH="$HOME/.config/syn-syu/config.toml"
readonly DEFAULT_GROUPS_PATH="$HOME/.config/syn-syu/groups.toml"
readonly DEFAULT_MANIFEST="$HOME/.config/syn-syu/manifest.json"
readonly DEFAULT_PLAN_PATH="$HOME/.config/syn-syu/plan.json"

CONFIG_PATH=""
GROUPS_PATH="$DEFAULT_GROUPS_PATH"
SYN_MANIFEST_PATH="$DEFAULT_MANIFEST"
PLAN_PATH="$DEFAULT_PLAN_PATH"
LOG_VERBOSE=0
LOG_LEVEL="info"
LOG_RETENTION_DAYS=0
LOG_RETENTION_SIZE_MB=0
REBUILD_MANIFEST=0
DRY_RUN=0
NO_AUR=0
NO_REPO=0
NO_CONFIRM=1
QUIET=0
JSON_OUTPUT=0
STRICT_MODE=0
EDIT_PLAN=0
declare -a INCLUDE_PATTERNS=()
declare -a EXCLUDE_PATTERNS=()
AUR_HELPER=""
BATCH_SIZE=10
SNAPSHOTS_ENABLED=0
SNAPSHOT_PRE_CMD=""
SNAPSHOT_POST_CMD=""
SNAPSHOT_REQUIRE_SUCCESS=0
MIN_FREE_SPACE_BYTES=$((2 * 1024 * 1024 * 1024))
MIN_FREE_SPACE_OVERRIDE_BYTES=""
DISK_CHECK=1
DISK_MARGIN_MB=0
SPACE_CHECK_PATH="/"
CLEAN_KEEP_VERSIONS=2
CLEAN_REMOVE_ORPHANS=0
CLEAN_CHECK_PACNEW=1
OFFLINE=0
FULL_PATH=0
APPLICATIONS_FLATPAK=0
APPLICATIONS_FWUPD=0
APPLICATIONS_FLATPAK_CLI=""
APPLICATIONS_FWUPD_CLI=""
declare -a FAILED_UPDATES=()
COMMAND=""
COMMAND_ARGS=()
HELPER_PRIORITY=()

trap 'handle_exit $?' EXIT
trap 'handle_interrupt' INT

#--- main
main() {
  ensure_prerequisites
  parse_cli "$@"
  parse_post_command_flags "$@"
  load_config
  log_init
  if [ "$NO_AUR" = "1" ] && [ "$NO_REPO" = "1" ]; then
    log_error "E103" "Cannot disable both repo and AUR operations"
    exit 103
  fi
  detect_helpers
  dispatch_command
}

main "$@"
